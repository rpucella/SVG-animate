<html>
  <head>

    <script src="http://d3js.org/d3.v3.min.js" charset="utf-8"></script>

    <script>
      


window.addEventListener("load",run);

function time (t) { return t; }

function faster (r,s) {
    return function (t) { return s(t * lift(r)(t)); };
}

function lift (v) { 
  return typeof v === "function" ? v : function(t) { return v; };
}


// non-streamed
function getRotationTranslation (node) { 
    var s = d3.select(node);
    var r = +s.attr("data-rotation");
    var rx = +s.attr("data-rotation-x");
    var ry = +s.attr("data-rotation-y");
    var tx = +s.attr("data-translation-x");
    var ty = +s.attr("data-translation-y");
    return {r: r?r:0, tx:tx?tx:0, ty:ty?ty:0,rx:rx?rx:0, ry:ry?ry:0};
}

function setRotationTranslation (node,r,tx,ty,rx,ry) { 
    var s = d3.select(node);
    s.attr("data-rotation",r);
    s.attr("data-rotation-x",rx);
    s.attr("data-rotation-y",ry);
    s.attr("data-translation-x",tx);
    s.attr("data-translation-y",ty);
    s.attr("transform","translate("+tx+","+ty+") rotate("+r+","+rx+","+ry+")");
}


/*
function rotate (node,deg,rx,ry) {
    var data = getRotationTranslation(node);
    var s = d3.select(node);
    setRotationTranslation(node,deg,data.tx,data.ty,rx,ry);
}


function translate (node,x,y) {
    var data = getRotationTranslation(node);
    var s = d3.select(node);
    setRotationTranslation(node,data.r,x,y,data.rx,data.ry);
}
*/

/*
 * Format function
 *
 * Use %as placeholder
 *
 */

(function(){

    function fmt () {
	var i = 0, args = arguments;
	return this.replace(/%/g, function () {
	    return typeof args[i] != 'undefined' ? args[i++] : '';
	});
    }

    if (!String.fmt) {
	String.prototype.fmt = fmt
    }
})();



function rotate (node,deg,rx,ry) {
    var s = d3.select(node);
    if (s.property("svg-animation-tag") != tag) {
	///console.log("rotate - new tag",tag,"replacing",s.property("svg-animation-tag"));
	s.property("svg-animation-tag",tag);
	s.attr("transform","rotate(%,%,%)".fmt(deg,rx,ry));
    } else {
	var t = s.attr("transform")
	///console.log("rotate - existing tag",tag,"adding to",t);
	s.attr("transform","rotate(%,%,%) %".fmt(deg,rx,ry,t));
    }
}


function translate (node,x,y) {
    var s = d3.select(node);
    if (+s.property("svg-animation-tag") !== tag) {
	s.property("svg-animation-tag",tag);
	///console.log("translate - new tag",tag,"replacing",s.property("svg-animation-tag"));
	s.attr("transform","translate(%,%)".fmt(x,y));
    } else {
	var t = s.attr("transform")
	///console.log("transform - existing tag",tag,"adding to",t);
	s.attr("transform","translate(%,%) %".fmt(x,y,t));
    }
}


function add (s1,s2) { 
  return function(t) { return lift(s1)(t) + lift(s2)(t); };
}

function mult (s1,s2) { 
  return function(t) { return lift(s1)(t) * lift(s2)(t); };
}

function apply (f,s) {
  return function(t) { return f(lift(s)(t)); }
}

var animId = 0;


// DIRTY DIRTY HACK!
var tag;

function animate (s,duration) { 

    if (animId !== 0) {
	cancelAnimationFrame(animId);
	animId = 0;
    }

    var start = performance.now();
    var now;

    var goWithDuration = function() { 
	///console.log("--------------------");
	now = performance.now()-start;
	tag = now;
	if (now < duration) { 
	    s(now);
	    animId = requestAnimationFrame(goWithDuration);
	} else {
	    console.log("BUSTED!");
	}
    }

    var go = function() { 
	///console.log("--------------------");
	now = performance.now()-start;
	tag = now;
	s(now);
	animId = requestAnimationFrame(go);
    }

    if (duration) { 
	goWithDuration();
    } else {
	go();
    }

}

function stop () {
    if (animId !== 0) {
	cancelAnimationFrame(animId);
	animId = 0;
    }
}

function print (s) { 
    return function(t) { console.log("@",t,"=",s(t)); };
}

var test = print(apply(function(x) { return x*2;},time));
var deg = apply(function(x) { return x % 360; },time);

function undef (x) { 
    return typeof x === "undefined";
}

function rot (node,s,cx,cy) { 
    return function(t) { 
	///console.log ("doing a rot");
	var n = lift(node)(t);
	if (undef(cx)) {
	    cx = n.x;
	}
	if (undef(cy)) { 
	    cy = n.y;
	}
	rotate(n.elt,lift(s)(t),cx,cy); 
	return n; }
}

function trans (node,x,y) { 
    return function(t) { 
	var n = lift(node)(t);
	translate(lift(node)(t).elt,
		  lift(x)(t),
		  lift(y)(t)); 
	return n;
    }
}

function wiggle (t) { 
    return Math.sin(t);
}

function waggle (t) { 
    return Math.cos(t);
}

function elt (id,orig_x,orig_y) { 
    var e = document.getElementById(id);
    return function(t) { return {elt:e, x:orig_x, y:orig_y};  }
}

function threshold (s1,thres,s2) {
    return function(t) { 
	if (t<thres) {
	    return s1(t);
	} else {
	    return s2(t-thres);
	}
    }
}

// produces an array of results
function over () {
    var args = [];
    for (var i=0; i<arguments.length; i++) {
	args.push(arguments[i]);
    }
    
    return function(t) { 
	var results = [];
	args.forEach(function(s,i) { results[i]=s(t); });
	///console.log(results);
	return results;
    }
}

function delay (d,s) { 
    return function(t) { 
	if (t < d) {
	    return;
	}
	return s(t-d);
    }
}


function rampTo (n,d) { 
    return function(t) { 
	if (t<d) { 
	    return (n*t/d);
	}
	return n;
    }
}
	

function spin (e,s) {
    return faster(s,rot(e,deg));
}

// invariant: 
//  time is always local to a behavior
//  behavior always starts @ t = 0

function run () { 

    console.log("Ready to animate");

/*    var rotR1 = faster(2,rot(elt("r1",200,200),deg)); */

    var rotR2 = faster(0.30,rot(elt("r2",750,250),mult(-1,deg)));

/*    var circR1 = threshold(trans(rotR1,
				 mult(rampTo(100,1000),faster(0.001,wiggle)),
				 mult(rampTo(100,1000),faster(0.001,waggle))),
			   5000,
			   trans(rotR1,
				 faster(add(0.001,rampTo(0.001,1000)),mult(100,wiggle)),
				 faster(add(0.001,rampTo(0.001,1000)),mult(100,waggle))));
*/

    var circR1 = trans(faster(0.3,rot(elt("r1",250,250),deg)),
		       mult(rampTo(100,1000),faster(0.005,wiggle)),
		       mult(rampTo(100,1000),faster(0.005,waggle)));

    var t = over(delay(1000,circR1),rotR2);

    t = over(t,rot(trans(spin(elt("r3",500,250),1),
			 faster(0.003,mult(200,wiggle)),
			 faster(0.003,mult(50,waggle))),
		   faster(0.005,deg),
		   500,250));


    animate(t) // ,6000);

}
      
    </script>
  </head>
  <body>
    <svg width="1000" height="500" style="border: 1px solid grey;">
        <rect id="r1" x="200" y="200" height="100" width="100" fill="red"></rect>
        <rect id="r2" x="700" y="200" height="100" width="100" fill="blue"></rect>
        <rect id="r3" x="450" y="230" width="100" height="40" fill="green"></rect>

    </svg>

  </body>
</html>
