<html>
  <head>

    <script src="http://d3js.org/d3.v3.min.js" charset="utf-8"></script>

    <script>
      
window.addEventListener("load",run);

/*
function time () { 
  return function(t) { return t; }
}
*/

function time (t) { return t; }

function faster (r,s) {
    return function (t) { return s(t * r); };
}

function lift (v) { 
  return typeof v === "function" ? v : function(t) { return v; };
}


// non-streamed
function getRotationTranslation (node) { 
    var s = d3.select(node);
    var r = +s.attr("data-rotation");
    var rx = +s.attr("data-rotation-x");
    var ry = +s.attr("data-rotation-y");
    var tx = +s.attr("data-translation-x");
    var ty = +s.attr("data-translation-y");
    return {r: r?r:0, tx:tx?tx:0, ty:ty?ty:0,rx:rx?rx:0, ry:ry?ry:0};
}

function setRotationTranslation (node,r,tx,ty,rx,ry) { 
    var s = d3.select(node);
    s.attr("data-rotation",r);
    s.attr("data-rotation-x",rx);
    s.attr("data-rotation-y",ry);
    s.attr("data-translation-x",tx);
    s.attr("data-translation-y",ty);
    s.attr("transform","translate("+tx+","+ty+") rotate("+r+","+rx+","+ry+")");
}


function rotate (node,deg,rx,ry) {
    var data = getRotationTranslation(node);
    var s = d3.select(node);
    setRotationTranslation(node,deg,data.tx,data.ty,rx,ry);
}


function translate (node,x,y) {
    var data = getRotationTranslation(node);
    var s = d3.select(node);
    setRotationTranslation(node,data.r,x,y,data.rx,data.ry);
}


function wiggle (t) { return sin(t); }

function waggle (t ) { return cos(t); }


function add (s1,s2) { 
  return function(t) { return lift(s1)(t) + lift(s2)(t); };
}

function mult (s1,s2) { 
  return function(t) { return lift(s1)(t) * lift(s2)(t); };
}

function apply (f,s) {
  return function(t) { return f(lift(s)(t)); }
}

var animId = 0;

function animate (s,duration) { 

    if (animId !== 0) {
	cancelAnimationFrame(animId);
	animId = 0;
    }

    var start = performance.now();
    var now;

    var goWithDuration = function() { 
	now = performance.now()-start;
	if (now < duration) { 
	    s(now);
	    animId = requestAnimationFrame(goWithDuration);
	} else {
	    console.log("BUSTED!");
	}
    }

    var go = function() { 
	now = performance.now()-start;
	s(now);
	animId = requestAnimationFrame(go);
    }

    if (duration) { 
	goWithDuration();
    } else {
	go();
    }

}

function stop () {
    if (animId !== 0) {
	cancelAnimationFrame(animId);
	animId = 0;
    }
}

function print (s) { 
    return function(t) { console.log("@",t,"=",s(t)); };
}

var test = print(apply(function(x) { return x*2;},time));
var deg = apply(function(x) { return x % 360; },time);


function rot (node,s,cx,cy) { 
    return function(t) { rotate(lift(node)(t),lift(s)(t),cx,cy); return lift(node)(t); }
}

function trans (node,x,y) { 
    return function(t) { translate(lift(node)(t),lift(x)(t),lift(y)(t)); return lift(node)(t);}
}

function wiggle (amp) {
    return function(t) { return amp * Math.sin(t); };
}

function waggle (amp) { 
    return function(t) { return amp * Math.cos(t); };
}

function elt (id) { 
    var e = document.getElementById(id);
    return function(t) { return e; }
}

function threshold (s1,thres,s2) {
    return function(t) { 
	if (t<thres) {
	    return s1(t);
	} else {
	    return s2(t);
	}
    }
}

function over () {
    var args = [];
    for (var i=0; i<arguments.length; i++) {
	args.push(arguments[i]);
    }
    
    return function(t) { 
	var results = [];
	args.forEach(function(s,i) { results[i]=s(t); });
	return results;
    }
}
    

function run () { 

    console.log("Ready to animate");

    var rotR1 = faster(0.50,rot(elt("r1"),deg,250,250));
    var rotR2 = faster(0.30,rot(elt("r2"),mult(-1,deg),750,250));
    var r = threshold(rotR1,5000,rotR2);
    var circR1 = trans(rotR1,faster(0.01,wiggle(100)),faster(0.01,waggle(100)));

    var t = over(circR1,rotR2);

    animate(t,10000);

}
      
    </script>
  </head>
  <body>
    <svg width="1000" height="500" style="border: 1px solid grey;">
        <rect id="r1" x="200" y="200" height="100" width="100" fill="red"></rect>
        <rect id="r2" x="700" y="200" height="100" width="100" fill="blue"></rect>
    </svg>

  </body>
</html>
