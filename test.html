<html>
  <head>

    <script src="http://d3js.org/d3.v3.min.js" charset="utf-8"></script>

    <script>
      
window.addEventListener("load",run);

/*
function time () { 
  return function(t) { return t; }
}
*/

function time (t) { return t; }

function faster (r,s) {
    return function (t) { return s(t * r); };
}

function lift (v) { 
  return typeof v === "function" ? v : function(t) { return v; };
}


// non-streamed
function getRotationTranslation (node) { 
    var s = d3.select(node);
    var r = +s.attr("data-rotation");
    var rx = +s.attr("data-rotation-x");
    var ry = +s.attr("data-rotation-y");
    var tx = +s.attr("data-translation-x");
    var ty = +s.attr("data-translation-y");
    return {r: r?r:0, tx:tx?tx:0, ty:ty?ty:0,rx:rx?rx:0, ry:ry?ry:0};
}

function setRotationTranslation (node,r,tx,ty,rx,ry) { 
    var s = d3.select(node);
    s.attr("data-rotation",r);
    s.attr("data-rotation-x",rx);
    s.attr("data-rotation-y",ry);
    s.attr("data-translation-x",tx);
    s.attr("data-translation-y",ty);
    s.attr("transform","translate("+tx+","+ty+") rotate("+r+","+rx+","+ry+")");
}


function rotate (node,deg,rx,ry) {
    var data = getRotationTranslation(node);
    var s = d3.select(node);
    setRotationTranslation(node,deg,data.tx,data.ty,rx,ry);
}


function translate (node,x,y) {
    var data = getRotationTranslation(node);
    var s = d3.select(node);
    setRotationTranslation(node,data.r,x,y,data.rx,data.ry);
}


function wiggle (t) { return sin(t); }

function waggle (t ) { return cos(t); }


function add (s1,s2) { 
  return function(t) { return lift(s1)(t) + lift(s2)(t); };
}

function mult (s1,s2) { 
  return function(t) { return lift(s1)(t) * lift(s2)(t); };
}

function apply (f,s) {
  return function(t) { return f(lift(s)(t)); }
}

var animId = 0;

function animate (s) { 

    if (animId !== 0) {
	cancelAnimationFrame(animId);
	animId = 0;
    }

    var start = performance.now();
    var now;

    var go = function() { 
	now = performance.now()-start;
	s(now);
	animId = requestAnimationFrame(go);
    }

    go();
}

function stop () {
    if (animId !== 0) {
	cancelAnimationFrame(animId);
	animId = 0;
    }
}

function print (s) { 
    return function(t) { console.log("@",t,"=",s(t)); };
}

var test = print(apply(function(x) { return x*2;},time));
var deg = apply(function(x) { return x % 360; },time);

function rot (node,s) { 
    return function(t) { rotate(lift(node)(t),lift(s)(t),250,250); return lift(node)(t); }
}

function trans (node,x,y) { 
    return function(t) { translate(lift(node)(t),lift(x)(t),lift(y)(t)); return lift(node)(t);}
}

function wiggle (amp) {
    return function(t) { return amp * Math.sin(t); };
}

function waggle (amp) { 
    return function(t) { return amp * Math.cos(t); };
}


function run () { 

    console.log("Ready to animate");

}
      
    </script>
  </head>
  <body>
    <svg height="500" width="500" style="border: 1px solid grey;">
        <rect id="r1" x="200" y="200" height="100" width="100" fill="red"></rect>
    </svg>

  </body>
</html>
